---

- name: "Install epel repo"
  yum: 
    name: "epel-release"
    state: "installed"
  
- name: "Install scl repo (CentOS)"
  yum: 
    name: "centos-release-scl"
    state: "installed"
  when:
    - ansible_distribution == "CentOS"

- name: "Install scl repo (RedHat)"
  command: "yum-config-manager --enable rhel-server-rhscl-7-rpm" 
  when:
    - ansible_distribution == "RedHat"

- name: "Add elasticsearch repo"
  yum_repository:
    name: "elasticsearch-1.7"
    description: "Elasticsearch repository for 1.7.x packages"
    file: elasticsearch_repo
    gpgkey: "http://packages.elastic.co/GPG-KEY-elasticsearch"
    gpgcheck: yes
    baseurl: "http://packages.elastic.co/elasticsearch/1.7/centos"

- name: "Add rpmfusion repo (ffmpeg)"
  command: 'yum localinstall -y --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm https://download1.rpmfusion.org/nonfree/el/rpmfusion-nonfree-release-7.noarch.rpm'
  args:
    creates: "/etc/yum.repos.d/rpmfusion-free-updates.repo"

- name: "Install services "
  yum:
    name: "{{ item }}"
    state: "installed"
  with_items:
    - java-1.8.0-openjdk
    - gearmand
    - elasticsearch
    - memcached

- name: "Install AtoM dependencies"
  yum:
    name: "{{ item }}"
    state: "latest"
  with_items:
    - "ImageMagick"       # ↓ AtoM dependencies
    - "ghostscript"       #
    - "poppler-utils"     #
    - "ffmpeg"            #
    - "git"               # ↓ Build dependencies
    - "nodejs"            #
    - "make"              #
    - "gcc"               #
    - "http-parser"       #
    - "python-pip"        #
    - "python-setuptools" #

- name: "Install Sphinx"
  pip:
    name: "{{ item }}"
    state: "latest"
  with_items:
    - "sphinx"
    - "sphinxcontrib-httpdomain"
    - "sphinx_rtd_theme"

- name: "Install npm global dependencies (also required during the build)"
  npm:
    name: "{{ item }}"
    global: "yes"
  with_items:
    - "grunt-cli"
    - "less@<2.0.0"
   
- name: "Install and enable services"
  systemd:
     name: "{{ item }}"
     state: "restarted"
     enabled: "yes"
  with_items:
    - "mariadb"
    - "elasticsearch"
    - "gearmand"
    - "nginx"
    - "memcached"
